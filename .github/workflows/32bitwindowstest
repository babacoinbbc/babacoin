---
name: Babacoin Build
on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - develop
env:
  COIN_NAME: babacoin
  BUILD_DIR: babacoin-build
  COMPRESS_DIR: babacoin-compress
  TEST_LOG_ARTIFACT_DIR: test-logs
jobs:
  build-win:
    name: window build
    needs: checking-build-version
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Getting Version
        uses: actions/download-artifact@v1
        with:
          name: version
      - name: Extract version
        run: |
          cat version/version.txt >> $GITHUB_ENV
      - name: Install Required Packages
        run: |
          sudo apt-get update -y
          sudo apt-get upgrade -y
          sudo apt-get install curl build-essential libtool autotools-dev automake pkg-config python3 bsdmainutils cmake
          sudo apt-get install -y g++-mingw-w32-x86-32 gcc-mingw-w32-x86-32
          sudo update-alternatives --set x86_32-w32-mingw32-gcc /usr/bin/x86_32-w32-mingw32-gcc-posix
          sudo update-alternatives --set x86_32-w32-mingw32-g++ /usr/bin/x86_32-w32-mingw32-g++-posix
      - name: build depends
        run: |
          echo "building with $(nproc) threads"
          make -C depends -j$(nproc) HOST=x86_32-w32-mingw32
      - name: configure
        run: |
          ./autogen.sh
          ./configure --prefix=`pwd`/depends/x86_32-w32-mingw32
      - name: build binary
        run: |
          make -j$(nproc)
          mkdir -p $BUILD_DIR
          mv src/{babacoin-cli.exe,babacoin-tx.exe,babacoind.exe,qt/babacoin-qt.exe} $BUILD_DIR/
          strip $BUILD_DIR/*
      - name: generate checksum and compress
        run: |
          echo "buildng $BUILD_VERSION version"
          cd $BUILD_DIR
          shasum babacoin-cli.exe >> checksums.txt
          sha256sum babacoin-cli.exe >> checksums.txt
          shasum babacoind.exe >> checksums.txt
          sha256sum babacoind.exe >> checksums.txt
          shasum babacoin-tx.exe >> checksums.txt
          sha256sum babacoin-tx.exe >> checksums.txt
          shasum babacoin-qt.exe >> checksums.txt
          sha256sum babacoin-qt.exe >> checksums.txt
          cd ..
          zip -r ${COIN_NAME}-win-${BUILD_VERSION}.zip $BUILD_DIR/
          mkdir -p ${COMPRESS_DIR}
          mv ${COIN_NAME}-win-${BUILD_VERSION}.zip ${COMPRESS_DIR}/
          shasum ${COMPRESS_DIR}/${COIN_NAME}-win-${BUILD_VERSION}.zip >> ${COMPRESS_DIR}/checksums.txt
          sha256sum ${COMPRESS_DIR}/${COIN_NAME}-win-${BUILD_VERSION}.zip >> ${COMPRESS_DIR}/checksums.txt
          cat ${COMPRESS_DIR}/checksums.txt
      - name: Upload Binary Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.COIN_NAME }}-win-${{ env.BUILD_VERSION }}
          path: ${{ env.COMPRESS_DIR }}

